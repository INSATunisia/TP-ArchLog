<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Les Travaux Pratiques du cours Architectures Logicielles"><meta name=author content="Hela CHIKHAOUI & Lilia SFAXI"><link href=http://INSATunisia.github.io/TP-ArchLog/tp-ds/ rel=canonical><link rel=icon href=../img/favicon.ico><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.10"><title>Tp ds - Software Architecture Labs</title><link rel=stylesheet href=../assets/stylesheets/main.d6be258b.min.css><link rel=stylesheet href=../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Questrial:300,400,400i,700%7CSource+Code+Pro&display=fallback"><style>:root{--md-text-font:"Questrial";--md-code-font:"Source Code Pro"}</style><link rel=stylesheet href=../css/timeago.css><script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=teal> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#telecharger-pdf class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Software Architecture Labs" class="md-header__button md-logo" aria-label="Software Architecture Labs" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Software Architecture Labs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Tp ds </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=teal aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=teal aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/INSATunisia/TP-ArchLog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> INSATunisia/TP-ArchLog </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Software Architecture Labs" class="md-nav__button md-logo" aria-label="Software Architecture Labs" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> Software Architecture Labs </label> <div class=md-nav__source> <a href=https://github.com/INSATunisia/TP-ArchLog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> INSATunisia/TP-ArchLog </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Software Architecure Labs </a> </li> <li class=md-nav__item> <a href=../tp1/ class=md-nav__link> Lab1 - The SOLID principles </a> </li> <li class=md-nav__item> <a href=../tp2/ class=md-nav__link> Lab2 - MV* Architectures </a> </li> <li class=md-nav__item> <a href=../tp3/ class=md-nav__link> Lab3 - Microservices Architecture </a> </li> <li class=md-nav__item> <a href=../tp4/ class=md-nav__link> Lab4 - Towards more reactive microservices </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#telecharger-pdf class=md-nav__link> Télécharger PDF </a> </li> <li class=md-nav__item> <a href=#objectifs-du-tp class=md-nav__link> Objectifs du TP </a> </li> <li class=md-nav__item> <a href=#acknowledgement class=md-nav__link> Acknowledgement </a> </li> <li class=md-nav__item> <a href=#outils-et-versions class=md-nav__link> Outils et Versions </a> </li> <li class=md-nav__item> <a href=#architecture-microservices class=md-nav__link> Architecture Microservices </a> <nav class=md-nav aria-label="Architecture Microservices"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#presentation class=md-nav__link> Présentation </a> </li> <li class=md-nav__item> <a href=#architecture-proposee class=md-nav__link> Architecture Proposée </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#creation-des-microservices class=md-nav__link> Création des Microservices </a> <nav class=md-nav aria-label="Création des Microservices"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#microservice-productservice class=md-nav__link> Microservice ProductService </a> </li> <li class=md-nav__item> <a href=#plusieurs-instances-du-microservice-productservice class=md-nav__link> Plusieurs Instances du Microservice ProductService </a> </li> <li class=md-nav__item> <a href=#microservice-configservice class=md-nav__link> Microservice ConfigService </a> </li> <li class=md-nav__item> <a href=#microservice-discoveryservice class=md-nav__link> Microservice DiscoveryService </a> </li> <li class=md-nav__item> <a href=#microservice-proxyservice class=md-nav__link> Microservice ProxyService </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/INSATunisia/TP-ArchLog/edit/master/docs/tp-ds.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Tp ds</h1> <p><center><img src=../img/microservices.png width=50%></center></p> <h3 id=telecharger-pdf>Télécharger PDF<a class=headerlink href=#telecharger-pdf title="Permanent link">&para;</a></h3> <p><a href=../tp4.pdf><img alt="Download TP4" src=../img/pdf.png></a></p> <h3 id=objectifs-du-tp>Objectifs du TP<a class=headerlink href=#objectifs-du-tp title="Permanent link">&para;</a></h3> <ol> <li>Création de microservices avec Spring Boot et Spring Cloud</li> <li>Déploiement d'un microservice sur plusieurs instances</li> </ol> <h3 id=acknowledgement>Acknowledgement<a class=headerlink href=#acknowledgement title="Permanent link">&para;</a></h3> <p>Ce TP a été largement inspiré du travail d'un binôme d'étudiants en Génie Logiciel à l'INSAT, promotion 2017 (Houssem Ben Braiek et Hadhemi Jabnoun), que je tiens à féliciter et remercier.</p> <h3 id=outils-et-versions>Outils et Versions<a class=headerlink href=#outils-et-versions title="Permanent link">&para;</a></h3> <ul> <li><a href=https://projects.spring.io/spring-boot/ >Spring Boot</a> Version: 3.0.0</li> <li><a href=http://projects.spring.io/spring-cloud/ >Spring Cloud</a> Version 2021.0.5</li> <li><a href=https://www.jetbrains.com/idea/download/ >IntelliJ IDEA</a> Version Ultimate 2021.1.1 (ou tout autre IDE de votre choix)</li> </ul> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Vous trouverez dans la Classroom un lien pour activer la version étudiant de IntelliJ Ultimate. La version grauite ne permet pas de réaliser le TP.</p> </div> <h3 id=architecture-microservices>Architecture Microservices<a class=headerlink href=#architecture-microservices title="Permanent link">&para;</a></h3> <h4 id=presentation>Présentation<a class=headerlink href=#presentation title="Permanent link">&para;</a></h4> <p>Une architecture <a href=https://martinfowler.com/articles/microservices.html>Microservices</a> représente un moyen de concevoir les applications comme ensemble de services indépendamment déployables. Ces services doivent de préférence être organisés autours des compétences métier, de déploiement automatique, d'extrémités intelligentes et de contrôle décentralisé des technologies et des données.</p> <h4 id=architecture-proposee>Architecture Proposée<a class=headerlink href=#architecture-proposee title="Permanent link">&para;</a></h4> <p>L'objectif de ce travail est de montrer comment créer plusieurs services indépendamment déployables qui communiquent entre eux, en utilisant les facilités offertes par Spring Cloud et Spring Boot. <a href=http://projects.spring.io/spring-cloud/ >Spring Cloud</a> fournit des outils pour les développeurs pour construire rapidement et facilement des patrons communs de systèmes répartis (tel que des services de configuration, de découverte ou de routage intelligent). <a href=https://projects.spring.io/spring-boot/ >Spring Boot</a> permet de son côté de construire des applications Spring rapidement aussi rapidement que possible, en minimisant au maximum le temps de configuration, d'habitude pénible, des applications Spring.</p> <p>Nous allons donc créer les microservices suivants:</p> <ol> <li><em>Product Service</em> : Service principal, qui offre une API REST pour lister une liste de produits.</li> <li><em>Config Service</em> : Service de configuration, dont le rôle est de centraliser les fichiers de configuration des différents microservices dans un endroit unique.</li> <li><em>Proxy Service</em> : Passerelle se chargeant du routage d'une requête vers l'une des instances d'un service, de manière à gérer automatiquement la distribution de charge.</li> <li><em>Discovery Service</em>: Service permettant l'enregistrement des instances de services en vue d'être découvertes par d'autres services.</li> </ol> <p>L'architecture résultante aura l'allure suivante:</p> <p><center><img src=../img/tp-ds/archi.png></center></p> <h3 id=creation-des-microservices>Création des Microservices<a class=headerlink href=#creation-des-microservices title="Permanent link">&para;</a></h3> <h4 id=microservice-productservice>Microservice <strong>ProductService</strong><a class=headerlink href=#microservice-productservice title="Permanent link">&para;</a></h4> <p>Nous commençons par créer le service principal: <em>Product Service</em>.</p> <p><center><img src=../img/tp-ds/archi-s1.png></center></p> <p>Chaque microservice sera sous la forme d'un projet Spring. Pour créer rapidement et facilement un projet Spring avec toutes les dépendances nécessaires, Spring Boot fournit <em>Spring Initializr</em>.</p> <p>Pour cela, aller au site <em><a href=http://start.spring.io>start.spring.io</a></em>, et créer un projet avec les caractéristiques suivantes:</p> <ul> <li>Projet Maven avec Java et Spring Boot version 3.0.0</li> <li>Group: tn.insat.tpmicro</li> <li>Artifact: product-service</li> <li>Packaging : Jar</li> <li>Java : 17 (il faudrait installer cette version)</li> <li>Dépendances:<ul> <li>Spring Web</li> <li>Rest Repositories</li> <li>JPA : Java Persistence API</li> <li>H2 : base de données pour le stockage</li> <li>Actuator : pour le montoring et la gestion de l'application</li> <li>Eureka Discovery : pour l'intégration avec le <em>Discovery Service</em></li> <li>Config Client : pour l'intégration avec le <em>Config Service</em></li> </ul> </li> </ul> <p>Cliquer sur <em>Generate</em>, un fichier zip sera téléchargé. Suivre ensuite les étapes suivantes pour créer le microservice <em>ProductService</em>:</p> <ul> <li>Ouvrir le projet téléchargé avec IntelliJ IDEA.</li> <li>Sous le répertoire <em>src/main/java</em> et dans le package <em>tn.insat.tpmicro.productservice</em>, créer la classe <em>Product</em> suivante:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>javax.persistence.Entity</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>javax.persistence.GeneratedValue</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>javax.persistence.Id</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>java.io.Serializable</span><span class=p>;</span>

<span class=nd>@Entity</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Product</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=p>{</span>
    <span class=nd>@Id</span>
    <span class=nd>@GeneratedValue</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>id</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=p>;</span>
    <span class=kd>public</span> <span class=nf>Product</span><span class=p>(){</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=nf>Product</span><span class=p>(</span><span class=n>String</span> <span class=n>name</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getId</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>id</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setId</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>id</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getName</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>name</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setName</span><span class=p>(</span><span class=n>String</span> <span class=n>name</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>Cette classe est annotée avec JPA, pour stocker ensuite les objets <em>Product</em> dans la base de données H2 grâce à Spring Data. Pour cela, créer l'interface <em>ProductRepository</em> dans le même package:</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.data.jpa.repository.JpaRepository</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ProductRepository</span> <span class=kd>extends</span> <span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>Product</span> <span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=p>{</span>
<span class=p>}</span>
</code></pre></div> <p>Pour insérer les objets dans la base, nous utiliserons l'objet <em>Stream</em>. Pour cela, nous allons créer la classe <em>DummyDataCLR</em> :</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.boot.CommandLineRunner</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>java.util.stream.Stream</span><span class=p>;</span>

<span class=nd>@Component</span>
<span class=kd>class</span> <span class=nc>DummyDataCLR</span> <span class=kd>implements</span> <span class=n>CommandLineRunner</span> <span class=p>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>(</span><span class=n>String</span><span class=p>...</span> <span class=n>strings</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=p>{</span>
        <span class=n>Stream</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&quot;Pencil&quot;</span><span class=p>,</span> <span class=s>&quot;Book&quot;</span><span class=p>,</span> <span class=s>&quot;Eraser&quot;</span><span class=p>).</span><span class=na>forEach</span><span class=p>(</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>productRepository</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=k>new</span> <span class=n>Product</span><span class=p>(</span><span class=n>s</span><span class=p>)));</span>
        <span class=n>productRepository</span><span class=p>.</span><span class=na>findAll</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>getName</span><span class=p>()));</span>
    <span class=p>}</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>ProductRepository</span> <span class=n>productRepository</span><span class=p>;</span>

<span class=p>}</span>
</code></pre></div> <p>Nous remarquons ici que le <em>productRepository</em> sera instancié automatiquement grâce au mécanisme d'injection de dépendances, utilisé par Spring.</p> <p>Lancer la classe principale. Une base de données H2 sera créée et le <em>CommandLineRunner</em> se chargera de lui injecter les données.</p> <div class="admonition warning"> <p class=admonition-title>Attention</p> <p>Prenez soin d'utiliser JDK 17!</p> </div> <p>Pour exécuter votre application:</p> <ul> <li>Créer une configuration <em>mvn package</em> en faisant <em>Run-&gt;Edit Configurations</em> puis en créant une nouvelle configuration de type <em>Maven</em> avec la commande <em>package</em> comme suit:</li> </ul> <p><center><img src=../img/tp-ds/package.png width=60%></center></p> <p>Un répertoire <em>target</em> sera créé, contenant les classes générées.</p> <ul> <li>Lancer ensuite la configuration Spring Boot <em>ProductServiceApplication</em> créée par défaut par IntelliJ. Le résultat sur la console devrait ressembler à ce qui suit:</li> </ul> <p><img alt="Configuration Spring Boot" src=img/tp4/boot.png></p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Pour éviter de lancer à chaque fois les deux configurations, ajouter dans la deuxième configuration une dépendance vers la première, rajouter cette dernière dans la case <em>Before Launch: Build, Maven Goal, Activate Tool Window</em>, comme suit:</p> <p><img alt="Ajout dépendance" src=img/tp4/dependanceConfig.png></p> </div> <p>Pour tester votre application, ouvrir la page <a href=http://localhost:8080>http://localhost:8080</a> sur le navigateur. Vous obtiendrez (si tout se passe bien) le résultat suivant:</p> <p><img alt="Service REST" src=img/tp4/rest1.png></p> <p>Vous remarquerez que le service REST créé respecte automatiquement la norme <a href=https://spring.io/understanding/HATEOAS>HATEOAS</a>, qui offre dans les services REST, les liens pour naviguer dynamiquement entre les interfaces.</p> <p>Si vous naviguez vers la page <a href=http://localhost:8080/products>http://localhost:8080/products</a>, vous verrez la liste des produits, injectés par le CLR, comme suit:</p> <p><img alt="Liste Produits" src=img/tp4/products.png></p> <p>Pour voir les informations relatives à un seul produit, il suffit de connaître son ID: <a href=http://localhost:8080/products/1>http://localhost:8080/products/1</a>, par exemple.</p> <p>Pour rajouter une fonctionnalité de recherche par nom, par exemple, modifier l'interface <em>ProductRepository</em>, comme suit:</p> <p><div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.data.domain.Page</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.data.domain.Pageable</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.data.jpa.repository.JpaRepository</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.data.jpa.repository.Query</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.data.repository.query.Param</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.data.rest.core.annotation.RepositoryRestResource</span><span class=p>;</span>

<span class=nd>@RepositoryRestResource</span>
<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ProductRepository</span> <span class=kd>extends</span> <span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>Product</span> <span class=p>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=nd>@Query</span><span class=p>(</span><span class=s>&quot;select p from Product p where p.name like :name&quot;</span><span class=p>)</span>
    <span class=kd>public</span> <span class=n>Page</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span> <span class=nf>productByName</span><span class=p>(</span><span class=nd>@Param</span><span class=p>(</span><span class=s>&quot;name&quot;</span><span class=p>)</span> <span class=n>String</span> <span class=n>mc</span>
            <span class=p>,</span> <span class=n>Pageable</span> <span class=n>pageable</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> Pour tester cette fonctionnalité de recherche, aller au lien <a href="http://localhost:8080/products/search/productByName?name=Eraser">http://localhost:8080/products/search/productByName?name=Eraser</a></p> <p>Le résultat obtenu sera le suivant:</p> <p><img alt="Résultat de la recherche par nom" src=img/tp4/search.png></p> <p>La dépendance <em>Actuator</em> qui a été rajoutée au projet permet d'afficher des informations sur votre API REST sans avoir à implémenter explicitement la fonctionnalité. Par exemple, si vous allez vers <a href=http://localhost:8080/metrics>http://localhost:8080/metrics</a>, vous pourrez avoir plusieurs informations sur le microservice, tel que le nombre de threads, la capacité mémoire, la classe chargée en mémoire, etc. Mais d'abord, rajouter les deux lignes suivantes au fichier <em>src/main/resources/application.properties</em> pour (1) afficher des informations plus détaillées sur l'état du service et (2) désactiver les contraintes de sécurité par défaut:</p> <div class=highlight><pre><span></span><code><span class=na>  endpoints.health.sensitive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>false</span><span class=w></span>
<span class=na>  management.security.enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>false</span><span class=w></span>
</code></pre></div> <p>Relancer le projet. Le résultat obtenu en exécutant <a href=http://localhost:8080/metrics>http://localhost:8080/metrics</a> sera comme suit:</p> <p><img alt=Metrics src=img/tp4/metrics.png></p> <p>Les informations sur l'état du service sont affichées grâce à <a href=http://localhost:8080/health>http://localhost:8080/health</a></p> <p><img alt=Health src=img/tp4/health.png></p> <h4 id=plusieurs-instances-du-microservice-productservice>Plusieurs Instances du Microservice <strong>ProductService</strong><a class=headerlink href=#plusieurs-instances-du-microservice-productservice title="Permanent link">&para;</a></h4> <p>Nous allons maintenant créer d'autres instances du même service et les déployer sur des ports différents.</p> <p><center><img src=../img/tp4/archi-s2.png></center></p> <p>Pour lancer plusieurs instances du service <em>ProductService</em>, nous allons définir plusieurs configurations avec des numéros de port différents. Pour cela:</p> <ul> <li>Aller à <em>Run-&gt;Edit Configurations</em>, et copier la configuration <em>ProductServiceApplication</em> en la sélectionnant dans la barre latérale, et en cliquant sur l'icône <img alt=copy src=img/tp4/copy.png>. Une nouvelle configuration sera créée.</li> <li>Changer son nom: <em>ProductServiceApplication:8081</em></li> <li>Ajouter dans la case <em>Program Arguments</em> l'argument suivant:</li> </ul> <div class=highlight><pre><span></span><code><span class=na>--server.port</span><span class=o>=</span><span class=s>8081</span><span class=w></span>
</code></pre></div> <ul> <li>Lancer la configuration. Un nouveau service sera disponible à l'adresse: <a href=http://localhost:8081>http://localhost:8081</a></li> </ul> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>En exécutant la seconde configuration, un popup s'affiche dans IntelliJ, qui vous demande si vous voulez afficher le dashboard pour visualiser plusieurs instances Spring Boot, comme suit:</p> <p><img alt="Run dashboard" src=img/tp4/run-dashboard.png></p> <p>Cliquer dessus, et choisir : <em>Show Run Configurations in Dashboard</em>. La vue suivante s'affiche, en bas de votre écran:</p> <p><img alt="Spring Boot Dashboard" src=img/tp4/dashboard.png></p> <p>Vous pouvez désormais gérer vos instances dans cette fenêtre.</p> </div> <ul> <li>Refaire les mêmes étapes pour créer une instance du service tourant sur le port 8082.</li> </ul> <h4 id=microservice-configservice>Microservice <strong>ConfigService</strong><a class=headerlink href=#microservice-configservice title="Permanent link">&para;</a></h4> <p>Dans une architecture microservices, plusieurs services s'exécutent en même temps, sur des processus différents, avec chacun sa propre configuration et ses propres paramètres. Spring Cloud Config fournit un support côté serveur et côté client pour externaliser les configurations dans un système distribué. Grâce au service de configuration, il est possible d'avoir un endroit centralisé pour gérer les propriétés de chacun de ces services.</p> <p><center><img src=../img/tp4/archi-s3.png></center></p> <p>Pour cela:</p> <ul> <li>Commencer par créer un service ConfigService dans <em>Spring Initializr</em>, avec les dépendances appropriées, comme indiqué sur la figure suivante:</li> </ul> <p><img alt="Nouveau ConfigService" src=img/tp4/configservice.png></p> <ul> <li>Ouvrir le projet dans une autre instance d'IntelliJ IDEA.</li> <li>Pour exposer un service de configuration, utiliser l'annotation <em>@EnableConfigServer</em> pour la classe <em>ConfigServiceApplication</em>, comme suit:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.configservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.cloud.config.server.EnableConfigServer</span><span class=p>;</span>

<span class=nd>@EnableConfigServer</span>
<span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ConfigServiceApplication</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>

        <span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ConfigServiceApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <ul> <li>Pour paramétrer ce service de configuration, ajouter dans son fichier <em>application.properties</em> les valeurs suivantes:</li> </ul> <div class=highlight><pre><span></span><code><span class=na>  server.port</span><span class=o>=</span><span class=s>8888</span><span class=w></span>
<span class=na>  spring.cloud.config.server.git.uri</span><span class=o>=</span><span class=s>file:./src/main/resources/myConfig</span><span class=w></span>
</code></pre></div> <p>Ceci indique que le service de configuration sera lancé sur le port 8888 et que le répertoire contenant les fichiers de configuration se trouve dans le répertoire <em>src/main/resources/myConfig</em>. Il suffit maintenant de créer ce répertoire.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Pour pouvoir référencer un répertoire avec son chemin absolu, utiliser plutôt <em>file:///&lt;chemin_absolu></em>.</p> </div> <ul> <li>Créer le répertoire <em>myConfig</em> à l'arborescence <em>src/main/resources</em></li> <li>Créer dans ce répertoire le fichier <em>application.properties</em> dans lequel vous insérez l'instruction suivante:</li> </ul> <div class=highlight><pre><span></span><code><span class=na>global</span><span class=o>=</span><span class=s>xxxxx</span><span class=w></span>
</code></pre></div> <p>Ce fichier sera partagé entre tous les microservices utilisant ce service de configuration.</p> <ul> <li>Le répertoire de configuration doit être un répertoire git. Pour cela:<ul> <li>Ouvrir le terminal avec IntelliJ et naviguer vers ce répertoire.</li> <li>Initialiser votre répertoire: <code>git init</code></li> <li>Créer une entrée racine dans le repository: <code>git add .</code></li> <li>Faire un commit: <code>git commit -m "add ."</code></li> </ul> </li> </ul> <p>Revenir vers le projet <em>ProductService</em> et ajouter dans le fichier de configuration <em>application.properties</em>:</p> <div class=highlight><pre><span></span><code><span class=na>spring.application.name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>product-service</span><span class=w></span>
<span class=na>spring.cloud.config.uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>http://localhost:8888</span><span class=w></span>
</code></pre></div> <p>Redémarrer vos services. Pour consulter le service de configuration, aller à <a href=http://localhost:8888/product-service/master>http://localhost:8888/product-service/master</a>.</p> <p>Vous verrez le fichier JSON suivant:</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
  <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;product-service&quot;</span><span class=p>,</span>
  <span class=nx>profiles</span><span class=o>:</span> <span class=p>[</span>
    <span class=s2>&quot;master&quot;</span>
  <span class=p>],</span>
  <span class=nx>label</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
  <span class=nx>version</span><span class=o>:</span> <span class=s2>&quot;6e1ea61d706133e2d8b62f40c6b784192fb58e8a&quot;</span><span class=p>,</span>
  <span class=nx>state</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
  <span class=nx>propertySources</span><span class=o>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;file:./src/main/resources/myConfig/application.properties&quot;</span><span class=p>,</span>
      <span class=nx>source</span><span class=o>:</span> <span class=p>{</span>
        <span class=nb>global</span><span class=o>:</span> <span class=s2>&quot;xxxxx&quot;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></div> <p>Comme le fichier <em>application.properties</em> contient toutes les propriétés partagées des différents microservices, nous aurons besoins d'autres fichiers pour les propriétés spécifiques à un microservice. Pour cela:</p> <ul> <li>Créer dans le répertoire <em>myConfig</em> un fichier <em>product-service.properties</em> pour le service <em>ProductService</em>.</li> </ul> <div class="admonition warning"> <p class=admonition-title>Attention</p> <p>Le nom du fichier doit correspondre à la propriété <em>spring.application.name</em> que vous avez saisi dans le fichier <em>application.properties</em> de votre microservice!</p> </div> <ul> <li>Ajouter les propriétés de votre service, à savoir, par exemple:</li> </ul> <div class=highlight><pre><span></span><code><span class=na>  me</span><span class=o>=</span><span class=s>lilia.sfaxi@insat.rnu.tn</span><span class=w></span>
</code></pre></div> <p>Relancer le microservice de configuration. En consultant l'url <a href=http://localhost:8888/product-service/master>http://localhost:8888/product-service/master</a>, nous remarquons l'ajout de la nouvelle propriété.</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
  <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;product-service&quot;</span><span class=p>,</span>
  <span class=nx>profiles</span><span class=o>:</span> <span class=p>[</span>
    <span class=s2>&quot;master&quot;</span>
  <span class=p>],</span>
  <span class=nx>label</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
  <span class=nx>version</span><span class=o>:</span> <span class=s2>&quot;6e1ea61d706133e2d8b62f40c6b784192fb58e8a&quot;</span><span class=p>,</span>
  <span class=nx>state</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
  <span class=nx>propertySources</span><span class=o>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;file:./src/main/resources/myConfig/product-service.properties&quot;</span><span class=p>,</span>
      <span class=nx>source</span><span class=o>:</span> <span class=p>{</span>
<span class=hll>        <span class=nx>me</span><span class=o>:</span> <span class=s2>&quot;lilia.sfaxi@insat.rnu.tn&quot;</span>
</span>      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;file:./src/main/resources/myConfig/application.properties&quot;</span><span class=p>,</span>
      <span class=nx>source</span><span class=o>:</span> <span class=p>{</span>
        <span class=nb>global</span><span class=o>:</span> <span class=s2>&quot;xxxxx&quot;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></div> <p>Nous allons maintenant définir un appel REST à cette propriété. Pour cela:</p> <ul> <li>Créer la classe <em>ProductRestService</em> dans le projet <em>product-service</em>. Son code ressemblera à ce qui suit:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestMapping</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RestController</span><span class=p>;</span>

<span class=nd>@RestController</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProductRestService</span> <span class=p>{</span>

  <span class=nd>@Value</span><span class=p>(</span><span class=s>&quot;${me}&quot;</span><span class=p>)</span>
  <span class=kd>private</span> <span class=n>String</span> <span class=n>me</span><span class=p>;</span>

  <span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&quot;/messages&quot;</span><span class=p>)</span>
  <span class=kd>public</span> <span class=n>String</span> <span class=nf>tellMe</span><span class=p>(){</span>
      <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;c&#39;est moi qui ai répondu!&quot;</span><span class=p>);</span>
      <span class=k>return</span> <span class=n>me</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <ul> <li>Redémarrer les trois instances du service, puis appeler dans votre navigateur le service en tapant: <a href=http://localhost:8080/messages>http://localhost:8080/messages</a>. Vous verrez le résultat suivant sur le navigateur:</li> </ul> <p><img alt="Service REST" src=img/tp4/rest-service.png></p> <ul> <li>Consulter votre Spring Dashboard, vous verrez le message suivant dans la console de l'instance du service lancée sur le port 8080:</li> </ul> <p><img alt="Service REST" src=img/tp4/rest-console.png></p> <h4 id=microservice-discoveryservice>Microservice <strong>DiscoveryService</strong><a class=headerlink href=#microservice-discoveryservice title="Permanent link">&para;</a></h4> <p>Pour éviter un couplage fort entre microservices, il est fortement recommandé d'utiliser un service de découverte qui permet d'enregistrer les propriétés des différents services et d'éviter ainsi d'avoir à appeler un service directement. Au lieu de cela, le service de découverte fournira dynamiquement les informations nécessaires, ce qui permet d'assurer l'élasticité et la dynamicité propres à une architecture microservices.</p> <p><center><img src=../img/tp4/archi-s4.png></center></p> <p>Pour réaliser cela, Netflix offre le service <a href=https://spring.io/guides/gs/service-registration-and-discovery/ >Eureka Service Registration and Discovery</a>, que nous allons utiliser dans notre application.</p> <ul> <li>Revenir à <em>Spring Initializr</em> et créer un nouveau projet Spring Boot intitulé <em>discovery-service</em> avec les dépendances <em>Eureka Server</em> et <em>Config Client</em>.</li> <li>Lancer le projet avec IntelliJ.</li> <li>Dans la classe <em>DiscoveryServiceApplication</em>, ajouter l'annotation <em>EnableEurekaServer</em>.</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.discoveryservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class=p>;</span>

<span class=nd>@EnableEurekaServer</span>
<span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiscoveryServiceApplication</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>DiscoveryServiceApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <ul> <li>Ajouter les propriétés suivantes dans son fichier <em>application.properties</em>.</li> </ul> <div class=highlight><pre><span></span><code><span class=na>spring.application.name</span><span class=o>=</span><span class=s>discovery-service</span><span class=w></span>
<span class=na>spring.cloud.config.uri</span><span class=o>=</span><span class=s>http://localhost:8888</span><span class=w></span>
</code></pre></div> <ul> <li>Dans le projet <em>config-service</em>, créer un fichier <em>discovery-service.properties</em> sous le répertoire <em>myConfig</em>.</li> <li>Ajouter les propriétés suivantes pour (1) définir le port par défaut du service de découverte et (2) empêcher un auto-enregistrement du service Eureka.</li> </ul> <div class=highlight><pre><span></span><code><span class=na>server.port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>8761</span><span class=w></span>
<span class=na>eureka.client.fetch-registry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>false</span><span class=w></span>
<span class=na>eureka.client.register-with-eureka</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>false</span><span class=w></span>
</code></pre></div> <p>Pour consulter le service Eureka, aller à <a href=http://localhost:8761>http://localhost:8761</a>, l'interface suivante s'affiche:</p> <p><img alt="Console Eureka" src=img/tp4/eureka-console.png></p> <p>Nous remarquons qu'aucune instance n'est inscrite dans le serveur de découverte. Nous allons donc modifier le code de la classe <em>ProductServiceApplication</em> pour que le microservice <em>ProductService</em> s'enregistre:</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tpmicro.productservice</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class=p>;</span>

<span class=hll><span class=nd>@EnableDiscoveryClient</span>
</span><span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProductServiceApplication</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ProductServiceApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>Redémarrer les trois instances de services <em>ProductService</em> et actualiser la fenêtre de <em>Eureka</em>, vous verrez qu'un seul service est déclaré, avec trois adresses différentes.</p> <p><img alt="Services sur Eureka" src=img/tp4/eureka-services.png></p> <h4 id=microservice-proxyservice>Microservice <strong>ProxyService</strong><a class=headerlink href=#microservice-proxyservice title="Permanent link">&para;</a></h4> <p>L'architecture microservices, en fournissant un ensemble de services indépendants et faiblement couplés, se trouve confrontée au challenge de fournir une interface unifiée pour les consommateurs, de manière à ce qu'ils ne voient pas la décomposition à faible granularité de vos services. C'est pour cela que l'utilisation d'un service proxy, responsable du routage des requêtes et de la répartition de charge, est important.</p> <p><center><img src=../img/tp4/archi-s5.png></center></p> <p>Netflix offre le service <a href=https://github.com/Netflix/zuul>Zuul</a> pour réaliser cela. Pour créer votre microservice Proxy:</p> <ul> <li>Aller à <em>Spring Initializr</em>.</li> <li>Créer le projet <em>proxy-service</em> avec les dépendances suivantes: Zuul, Web, HATEOAS, Actuator, Config Client et Eureka Discovery.</li> <li>Ouvrir le service avec IntelliJ IDEA.</li> <li>Ajouter à la classe <em>ProxyServiceApplication</em> l'annotation <em>@EnableZuulProxy</em>, ainsi que <em>@EnableDiscoveryClient</em> pour que le proxy soit également enregistré dans le service de découverte.</li> <li>Ajouter les propriétés <em>spring.application.name</em> et <em>spring.cloud.config.uri</em> dans le fichier <em>application.properties</em> du service proxy.</li> <li>Créer le fichier <em>proxy-service.properties</em> dans le répertoire <em>myConfig</em> du service de configuration, dans lequel vous allez fixer le port du service proxy à 9999.</li> </ul> <p>En lançant le service Proxy, vous remarquerez qu'il est rajouté dans Eureka.</p> <p><img alt="Service Proxy dans Eureka" src=img/tp4/proxy-eureka.png></p> <p>Si vous exécutez la requête <a href=http://localhost:9999/product-service/messages>http://localhost:9999/product-service/messages</a> plusieurs fois, vous remarquerez que l'affichage <em>c'est moi qui ai répondu!</em> s'affichera sur les consoles des trois instances respectivement, à tour de rôle.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2023-04-07T09:16:01+01:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-04-07</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 - 2023 Hela Chikhaoui & Lilia Sfaxi </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../assets/javascripts/bundle.e3b2bf44.min.js></script> <script src=../js/timeago.min.js></script> <script src=../js/timeago_mkdocs_material.js></script> </body> </html>